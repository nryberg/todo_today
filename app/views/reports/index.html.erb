<div class="reports-header">
  <h2>Completion Reports</h2>

  <div class="report-filters">
    <%= link_to "7 Days", reports_path(days: 7), class: "btn #{@days == 7 ? 'btn-primary' : 'btn-secondary'}" %>
    <%= link_to "30 Days", reports_path(days: 30), class: "btn #{@days == 30 ? 'btn-primary' : 'btn-secondary'}" %>
    <%= link_to "90 Days", reports_path(days: 90), class: "btn #{@days == 90 ? 'btn-primary' : 'btn-secondary'}" %>
  </div>
</div>

<% if @tasks.empty? %>
  <div class="empty-state">
    <p>No tasks to report on. <%= link_to "Create your first task", new_task_path %>.</p>
  </div>
<% else %>
  <div class="reports-container">
    <% @tasks.each do |task| %>
      <div class="report-card">
        <div class="report-card-header">
          <h3><%= task.name %></h3>
          <div class="completion-stats">
            <span class="completion-rate"><%= task.completion_rate(@days) %>%</span>
            <span class="completion-label">completion rate</span>
          </div>
        </div>

        <div class="completion-calendar">
          <div class="calendar-header">
            <div class="weekday">Sun</div>
            <div class="weekday">Mon</div>
            <div class="weekday">Tue</div>
            <div class="weekday">Wed</div>
            <div class="weekday">Thu</div>
            <div class="weekday">Fri</div>
            <div class="weekday">Sat</div>
          </div>

          <div class="calendar-grid">
            <%
              # Get all days in the range
              all_days = @task_completions[task.id]

              # Find the first day and pad to start on Sunday
              first_date = all_days.first[:date]
              start_of_calendar = first_date - first_date.wday.days

              # Find the last day and pad to end on Saturday
              last_date = all_days.last[:date]
              end_of_calendar = last_date + (6 - last_date.wday).days

              # Create a hash for quick lookup
              completion_lookup = {}
              all_days.each { |day| completion_lookup[day[:date]] = day[:completed] }

              # Generate calendar grid
              current_date = start_of_calendar
              while current_date <= end_of_calendar
                in_range = current_date >= first_date && current_date <= last_date
                completed = completion_lookup[current_date] || false
            %>
              <div class="calendar-day <%= 'completed' if completed %> <%= 'out-of-range' unless in_range %>"
                   title="<%= current_date.strftime('%b %d, %Y') %> - <%= completed ? 'Completed' : (in_range ? 'Not completed' : 'Outside range') %>">
                <span class="day-label"><%= current_date.day %></span>
              </div>
            <%
                current_date += 1.day
              end
            %>
          </div>
        </div>

        <div class="calendar-legend">
          <div class="legend-item">
            <div class="legend-dot completed"></div>
            <span>Completed</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot"></div>
            <span>Not completed</span>
          </div>
        </div>

        <div class="report-footer">
          <small>Showing last <%= @days %> days</small>
        </div>
      </div>
    <% end %>
  </div>

  <div class="report-summary">
    <h3>Summary</h3>
    <table class="summary-table">
      <thead>
        <tr>
          <th>Task</th>
          <th>Completion Rate</th>
          <th>Days Completed</th>
          <th>Days Missed</th>
        </tr>
      </thead>
      <tbody>
        <% @tasks.each do |task| %>
          <% completed_days = @task_completions[task.id].count { |d| d[:completed] } %>
          <% total_days = @task_completions[task.id].count %>
          <tr>
            <td><%= task.name %></td>
            <td><%= task.completion_rate(@days) %>%</td>
            <td><%= completed_days %></td>
            <td><%= total_days - completed_days %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<div class="report-actions">
  <%= link_to "Back to Tasks", tasks_path, class: "btn btn-secondary" %>
</div>
